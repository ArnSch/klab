const kast   = require('../lib/kast.js')
const assert = require('assert')

var callData
var flattenedCallData
var intToken

describe('testing KAST format', function() {

  beforeEach(function() {
    callData = {"node":"KApply","label":"<callData>","variable":false,"arity":1,"args":[{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KToken","sort":"Int","token":"10"},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KToken","sort":"Int","token":"249"},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KToken","sort":"Int","token":"213"},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KToken","sort":"Int","token":"224"},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"0"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"1"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"2"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"3"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"4"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"5"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"6"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"7"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"8"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"9"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"10"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"11"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"12"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"13"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"14"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"15"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"16"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"17"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"18"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"19"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"20"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"21"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"22"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"23"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"24"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"25"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"26"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"27"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"28"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"29"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"30"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"31"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_++__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"#padToWidth","variable":false,"arity":2,"args":[{"node":"KToken","sort":"Int","token":"32"},{"node":"KApply","label":"#asByteStack","variable":false,"arity":1,"args":[{"node":"KApply","label":"#unsigned","variable":false,"arity":1,"args":[{"node":"KVariable","name":"Delta_D"}]}]}]},{"node":"KApply","label":".WordStack_EVM-DATA","variable":false,"arity":0,"args":[]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}
    flattenedCallData = {"node":"KApply","label":"<callData>","variable":false,"arity":1,"args":[{"node":"KApply","label":"_:__EVM-DATA","variable":false,"arity":37,"args":[{"node":"KToken","sort":"Int","token":"10"},{"node":"KToken","sort":"Int","token":"249"},{"node":"KToken","sort":"Int","token":"213"},{"node":"KToken","sort":"Int","token":"224"},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"0"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"1"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"2"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"3"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"4"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"5"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"6"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"7"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"8"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"9"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"10"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"11"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"12"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"13"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"14"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"15"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"16"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"17"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"18"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"19"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"20"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"21"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"22"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"23"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"24"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"25"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"26"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"27"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"28"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"29"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"30"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"nthbyteof","variable":false,"arity":3,"args":[{"node":"KVariable","name":"V_u"},{"node":"KToken","sort":"Int","token":"31"},{"node":"KToken","sort":"Int","token":"32"}]},{"node":"KApply","label":"_++__EVM-DATA","variable":false,"arity":2,"args":[{"node":"KApply","label":"#padToWidth","variable":false,"arity":2,"args":[{"node":"KToken","sort":"Int","token":"32"},{"node":"KApply","label":"#asByteStack","variable":false,"arity":1,"args":[{"node":"KApply","label":"#unsigned","variable":false,"arity":1,"args":[{"node":"KVariable","name":"Delta_D"}]}]}]},{"node":"KApply","label":".WordStack_EVM-DATA","variable":false,"arity":0,"args":[]}]}]}]}
    intToken = {"node":"KToken","sort":"Int","token":"1"}
  })

  it('omitArgs should not do anything to tokens', function() {
    assert.deepEqual(kast.omitArgs(intToken), intToken)
  })
  it('omitArgs should remove the arguments to the node `<callData>`', function() {
    assert.deepEqual(kast.omitArgs(callData), kast.KApply("<callData>", []))
  })

  it('visitChildren should not do anything to tokens', function() {
    assert.deepEqual(kast.visitChildren(intToken, (arg => {})), intToken)
  })
  it('visitChildren should be able to replace children with other children', function() {
    assert.deepEqual(kast.visitChildren(callData, (arg => intToken)), kast.KApply("<callData>", [intToken]))
  })

  it('visitTopDown should ignore non-KApplys', function() {
    assert.deepEqual(intToken, kast.visitTopDown(intToken, kast.omitArgs))
  })
  it('visitBottomUp should ignore non-KApplys', function() {
    assert.deepEqual(intToken, kast.visitBottomUp(intToken, kast.omitArgs))
  })

  it('flattenKLabel of `_:__EVM-DATA`', function() {
    assert.deepEqual(flattenedCallData, kast.visitBottomUp(callData, kast.flattenKLabel("_:__EVM-DATA")))
    assert.deepEqual(flattenedCallData, kast.visitTopDown(callData, kast.flattenKLabel("_:__EVM-DATA")))
  })
})
